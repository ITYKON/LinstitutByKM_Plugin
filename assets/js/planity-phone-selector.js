/**
 * S√©lecteur de t√©l√©phone custom Planity
 * Remplace compl√®tement intl-tel-input par un composant sur mesure
 * Palette noir/gris/blanc
 */

document.addEventListener("DOMContentLoaded", function () {
  // Pays avec codes et drapeaux
  const countries = [
    { code: "FR", name: "France", dial: "+33", flag: "üá´üá∑" },
    { code: "DZ", name: "Alg√©rie", dial: "+213", flag: "üá©üáø" },
    { code: "MA", name: "Maroc", dial: "+212", flag: "üá≤üá¶" },
    { code: "TN", name: "Tunisie", dial: "+216", flag: "üáπüá≥" },
    { code: "DE", name: "Allemagne", dial: "+49", flag: "üá©üá™" },
    { code: "ES", name: "Espagne", dial: "+34", flag: "üá™üá∏" },
    { code: "IT", name: "Italie", dial: "+39", flag: "üáÆüáπ" },
    { code: "GB", name: "Royaume-Uni", dial: "+44", flag: "üá¨üáß" },
    { code: "US", name: "√âtats-Unis", dial: "+1", flag: "üá∫üá∏" },
    { code: "CA", name: "Canada", dial: "+1", flag: "üá®üá¶" },
    { code: "BE", name: "Belgique", dial: "+32", flag: "üáßüá™" },
    { code: "CH", name: "Suisse", dial: "+41", flag: "üá®üá≠" },
    { code: "LU", name: "Luxembourg", dial: "+352", flag: "üá±üá∫" },
  ];

  let selectedCountry = countries[1]; // Alg√©rie par d√©faut

  function createPlanityPhoneField(container, phoneInput) {
    // V√©rifier si d√©j√† remplac√©
    if (container.classList.contains("planity-phone-replaced")) {
      return;
    }

    // Marquer comme remplac√©
    container.classList.add("planity-phone-replaced");

    console.log("üîß Cr√©ation du champ t√©l√©phone Planity pour:", phoneInput);

    // Cr√©er le nouveau container Planity
    const planityContainer = document.createElement("div");
    planityContainer.className = "planity-phone-container";
    planityContainer.style.cssText = `
            width: 100%;
            border-radius: 12px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            padding: 0;
            display: flex;
            align-items: center;
            min-height: 52px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

    // Cr√©er le s√©lecteur de pays
    const countrySelector = document.createElement("div");
    countrySelector.className = "planity-country-selector";
    countrySelector.style.cssText = `
            min-width: 160px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            border-radius: 10px 0 0 10px;
            border-right: 2px solid #e5e7eb;
            padding: 0 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        `;

    // Contenu du s√©lecteur
    countrySelector.innerHTML = `
            <span class="planity-flag" style="font-size: 20px; margin-right: 8px;">${selectedCountry.flag}</span>
            <span class="planity-dial" style="color: #374151; font-weight: 600; font-size: 14px; margin-right: 4px;">${selectedCountry.dial}</span>
            <span class="planity-arrow" style="border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid #6b7280; border-bottom: none; transition: transform 0.2s ease;"></span>
        `;

    // Cr√©er le dropdown
    const dropdown = document.createElement("div");
    dropdown.className = "planity-country-dropdown";
    dropdown.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

    // Ajouter les pays au dropdown
    countries.forEach(function (country) {
      const countryItem = document.createElement("div");
      countryItem.className = "planity-country-item";
      countryItem.style.cssText = `
                padding: 12px 16px;
                background: #ffffff;
                color: #374151;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 12px;
                margin: 0;
                line-height: 1.4;
                border-bottom: 1px solid #f3f4f6;
            `;

      countryItem.innerHTML = `
                <span style="font-size: 16px; width: 20px; height: 15px; display: flex; align-items: center; justify-content: center; border-radius: 2px; border: 1px solid #e5e7eb; margin-right: 8px; flex-shrink: 0;">${country.flag}</span>
                <span style="color: #374151; font-weight: 500; font-size: 14px; flex: 1;">${country.name}</span>
                <span style="color: #6b7280; font-weight: 600; font-size: 13px; background: #f9fafb; padding: 4px 8px; border-radius: 6px; border: 1px solid #e5e7eb;">${country.dial}</span>
            `;

      // √âv√©nements hover
      countryItem.addEventListener("mouseenter", function () {
        this.style.background = "#f9fafb";
        this.style.color = "#111827";
      });

      countryItem.addEventListener("mouseleave", function () {
        this.style.background = "#ffffff";
        this.style.color = "#374151";
      });

      // S√©lection du pays - Support mobile am√©lior√©
      function selectCountry() {
        selectedCountry = country;

        // Mettre √† jour l'affichage
        countrySelector.querySelector(".planity-flag").textContent =
          country.flag;
        countrySelector.querySelector(".planity-dial").textContent =
          country.dial;

        // Fermer le dropdown
        dropdown.style.display = "none";
        countrySelector.querySelector(".planity-arrow").style.transform =
          "rotate(0deg)";

        // Focus sur l'input (avec d√©lai pour mobile)
        setTimeout(() => {
          newPhoneInput.focus();
        }, 100);

        console.log("üåç Pays s√©lectionn√©:", country.name, country.dial);
      }

      // √âv√©nements pour desktop et mobile
      countryItem.addEventListener("click", selectCountry);
      countryItem.addEventListener("touchend", function (e) {
        e.preventDefault();
        selectCountry();
      });

      dropdown.appendChild(countryItem);
    });

    // Cr√©er le nouvel input
    const newPhoneInput = document.createElement("input");
    newPhoneInput.type = "tel";
    newPhoneInput.placeholder = phoneInput.placeholder || "Num√©ro de t√©l√©phone";
    newPhoneInput.value = phoneInput.value || "";
    newPhoneInput.name = phoneInput.name || "phone";
    newPhoneInput.id = phoneInput.id || "client-phone";
    newPhoneInput.style.cssText = `
            width: 100%;
            border: none;
            background: transparent;
            border-radius: 0 10px 10px 0;
            padding: 16px;
            font-size: 16px;
            color: #111827;
            box-shadow: none;
            outline: none;
            height: 52px;
            line-height: 1.5;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

    // √âv√©nements du s√©lecteur - Support mobile am√©lior√©
    function toggleDropdown() {
      const isOpen = dropdown.style.display === "block";
      dropdown.style.display = isOpen ? "none" : "block";
      countrySelector.querySelector(".planity-arrow").style.transform = isOpen
        ? "rotate(0deg)"
        : "rotate(180deg)";

      // Am√©liorer la visibilit√© sur mobile
      if (!isOpen && window.innerWidth <= 768) {
        dropdown.style.zIndex = "99999";
        // Scroll vers le s√©lecteur sur mobile
        setTimeout(() => {
          planityContainer.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }, 100);
      }
    }

    countrySelector.addEventListener("click", toggleDropdown);
    countrySelector.addEventListener("touchend", function (e) {
      e.preventDefault();
      toggleDropdown();
    });

    // Hover du s√©lecteur
    countrySelector.addEventListener("mouseenter", function () {
      this.style.background = "#f3f4f6";
    });

    countrySelector.addEventListener("mouseleave", function () {
      this.style.background = "#f9fafb";
    });

    // Focus du container
    newPhoneInput.addEventListener("focus", function () {
      planityContainer.style.background = "#ffffff";
      planityContainer.style.borderColor = "#374151";
      planityContainer.style.boxShadow = "0 0 0 3px rgba(55, 65, 81, 0.1)";
    });

    newPhoneInput.addEventListener("blur", function () {
      planityContainer.style.background = "#ffffff";
      planityContainer.style.borderColor = "#e5e7eb";
      planityContainer.style.boxShadow = "none";
    });

    // Fermer le dropdown en cliquant ailleurs
    document.addEventListener("click", function (e) {
      if (!planityContainer.contains(e.target)) {
        dropdown.style.display = "none";
        countrySelector.querySelector(".planity-arrow").style.transform =
          "rotate(0deg)";
      }
    });

    // Assembler le composant
    planityContainer.appendChild(countrySelector);
    planityContainer.appendChild(newPhoneInput);
    planityContainer.appendChild(dropdown);

    // Remplacer l'ancien container
    container.parentNode.insertBefore(planityContainer, container);
    container.style.display = "none";

    // Fonctions globales pour r√©cup√©rer les valeurs
    window.getPlanityPhoneNumber = function () {
      return (
        selectedCountry.dial +
        " " +
        newPhoneInput.value.replace(/^\+?[\d\s-]+/, "").trim()
      );
    };

    window.getPlanityPhoneNumberOnly = function () {
      return newPhoneInput.value;
    };

    window.getPlanityCountryCode = function () {
      return selectedCountry.dial;
    };

    console.log("‚úÖ S√©lecteur t√©l√©phone Planity cr√©√© pour:", phoneInput);
  }

  function createCustomPhoneSelector() {
    // Trouver tous les champs t√©l√©phone
    const phoneContainers = document.querySelectorAll(
      '.phone-field-modern, .iti, [id*="phone"], input[type="tel"]'
    );

    // Si aucun container trouv√©, chercher directement l'input t√©l√©phone
    if (phoneContainers.length === 0) {
      const phoneInput = document.querySelector(
        '#client-phone, input[type="tel"]'
      );
      if (phoneInput && !phoneInput.closest(".planity-phone-replaced")) {
        console.log("üìû Input t√©l√©phone trouv√© directement:", phoneInput);
        createPlanityPhoneField(phoneInput.parentNode, phoneInput);
        return;
      }
    }

    phoneContainers.forEach(function (container) {
      // Si c'est directement un input, utiliser son parent
      if (container.tagName === "INPUT") {
        createPlanityPhoneField(container.parentNode, container);
        return;
      }

      // Trouver l'input t√©l√©phone dans le container
      let phoneInput = container.querySelector('input[type="tel"]');
      if (!phoneInput) {
        phoneInput = container.querySelector("input");
      }

      if (!phoneInput) {
        return;
      }

      createPlanityPhoneField(container, phoneInput);
    });
  }

  // Cr√©er le s√©lecteur custom
  createCustomPhoneSelector();

  // Observer les changements DOM pour les nouveaux √©l√©ments
  const observer = new MutationObserver(function (mutations) {
    mutations.forEach(function (mutation) {
      if (mutation.addedNodes.length > 0) {
        setTimeout(createCustomPhoneSelector, 100);
      }
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
  });

  // R√©essayer apr√®s un d√©lai - plus fr√©quent pour capturer les champs cr√©√©s dynamiquement
  setTimeout(createCustomPhoneSelector, 100);
  setTimeout(createCustomPhoneSelector, 500);
  setTimeout(createCustomPhoneSelector, 1000);
  setTimeout(createCustomPhoneSelector, 2000);
  setTimeout(createCustomPhoneSelector, 3000);
  setTimeout(createCustomPhoneSelector, 5000);

  // √âcouter les √©v√©nements personnalis√©s pour d√©clencher la cr√©ation
  document.addEventListener("stepChanged", createCustomPhoneSelector);
  document.addEventListener("formRendered", createCustomPhoneSelector);

  // Fonction globale pour forcer la cr√©ation
  window.forceCreatePlanityPhoneSelector = createCustomPhoneSelector;

  console.log("üé® Planity Phone Selector: Script charg√© et actif");
});
